<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Словарный Прицел</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    
    #game-area {
      position: relative;
      width: 100%;
      height: 100%;
      background: #1a4d8c; /* Запасной цвет */
      background-image: url('background_autumn_park.PNG');
      background-repeat: no-repeat;
      background-position: center;
      background-size: cover;
      user-select: none;
      overflow: hidden;
    }
    
    /* ПОДВОДНАЯ АНИМАЦИЯ - ПУЗЫРЬКИ */
    .bubble {
      position: absolute;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 50%;
      pointer-events: none;
      z-index: 50;
      animation: bubbleFloat linear infinite;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }
    
    @keyframes bubbleFloat {
      0% {
        transform: translateY(100vh) scale(0);
        opacity: 0;
      }
      10% {
        opacity: 0.7;
      }
      90% {
        opacity: 0.5;
      }
      100% {
        transform: translateY(-20vh) scale(1.5);
        opacity: 0;
      }
    }
    
    /* ПОДВОДНАЯ АНИМАЦИЯ - РЫБКИ */
    .fish {
      position: absolute;
      width: 70px;
      height: 40px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 50"><path fill="%23FFB347" d="M20,20 Q40,10 60,20 L80,10 L80,30 L60,20 Q40,30 20,20" /><circle fill="black" cx="30" cy="18" r="3"/></svg>') no-repeat center/contain;
      pointer-events: none;
      z-index: 100;
      opacity: 0.5;
      filter: hue-rotate(180deg) brightness(1.2);
      animation: fishSwim linear infinite;
    }
    
    .fish.reverse {
      transform: scaleX(-1);
    }
    
    @keyframes fishSwim {
      0% {
        transform: translateX(-100px);
      }
      100% {
        transform: translateX(calc(100vw + 100px));
      }
    }
    
    /* ПОДВОДНАЯ АНИМАЦИЯ - ВОДОРОСЛИ */
    .seaweed {
      position: absolute;
      bottom: 0;
      width: 40px;
      height: 150px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 150"><path fill="%232E7D32" d="M15,150 Q10,120 20,100 Q30,80 15,50 Q10,30 20,15 Q25,5 30,15 Q35,30 25,50 Q15,80 25,100 Q35,120 25,150" /></svg>') no-repeat center/contain;
      z-index: 200;
      animation: seaweedSway 5s ease-in-out infinite;
      transform-origin: bottom center;
      opacity: 0.8;
    }
    
    @keyframes seaweedSway {
      0%, 100% { transform: rotate(-5deg); }
      50% { transform: rotate(5deg); }
    }
    
    /* ВЗРЫВ ПРИ ПОПАДАНИИ */
    .explosion {
      position: absolute;
      width: 100px;
      height: 100px;
      pointer-events: none;
      z-index: 2000;
      animation: explosionAnim 0.5s ease-out forwards;
    }
    
    @keyframes explosionAnim {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 1;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.5);
        opacity: 0.8;
      }
      100% {
        transform: translate(-50%, -50%) scale(2);
        opacity: 0;
      }
    }
    
    .explosion-particle {
      position: absolute;
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, #00ffff, #0066ff);
      border-radius: 50%;
      filter: blur(2px);
      box-shadow: 0 0 10px #00ffff;
    }
    
    /* СЛОВО - ПО ЦЕНТРУ ВВЕРХУ */
    #word-display {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 3.5vw;
      font-weight: bold;
      color: white;
      text-shadow: 3px 3px 0 #000066, 5px 5px 0 rgba(0,0,0,0.5);
      letter-spacing: 15px;
      user-select: none;
      z-index: 1000;
      background: rgba(0, 40, 80, 0.7);
      padding: 15px 30px;
      border-radius: 20px;
      backdrop-filter: blur(5px);
      border: 3px solid #00aaff;
      box-shadow: 0 0 20px rgba(0, 170, 255, 0.5);
      white-space: nowrap;
      max-width: 90%;
      overflow-x: auto;
      text-align: center;
    }
    
    /* HUD - В ПРАВОМ ВЕРХНЕМ УГЛУ */
    #hud {
      position: absolute;
      top: 30px;
      right: 30px;
      display: flex;
      gap: 20px;
      align-items: center;
      font-weight: bold;
      background: rgba(0, 40, 80, 0.8);
      padding: 15px 25px;
      border-radius: 20px;
      backdrop-filter: blur(5px);
      border: 3px solid #00aaff;
      color: white;
      z-index: 1000;
      box-shadow: 0 0 20px rgba(0, 170, 255, 0.5);
    }
    
    #score {
      font-size: 2vw;
      color: #00ffff;
      text-shadow: 0 0 10px cyan;
    }
    
    #level {
      font-size: 1.8vw;
      color: #aaffff;
    }
    
    #lives {
      display: flex;
      gap: 8px;
    }
    
    .life {
      width: 35px;
      height: 35px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle fill="%23ff4444" cx="50" cy="50" r="40"/><text x="50" y="70" font-size="60" text-anchor="middle" fill="white" font-family="Arial">❤️</text></svg>') no-repeat center center / contain;
      filter: drop-shadow(0 0 10px #ff4444);
    }
    
    /* СООБЩЕНИЯ ПО ЦЕНТРУ */
    #encouragement-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 6vw;
      color: #00ffff;
      text-shadow: 4px 4px 0 #000066, 6px 6px 0 rgba(0,0,0,0.5);
      font-weight: bold;
      opacity: 0;
      pointer-events: none;
      z-index: 1500;
      white-space: nowrap;
    }
    
    #miss-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 7vw;
      color: #ff4444;
      text-shadow: 3px 3px 0 #000, 5px 5px 0 rgba(0,0,0,0.5);
      font-weight: bold;
      opacity: 0;
      pointer-events: none;
      z-index: 1500;
      white-space: nowrap;
    }
    
    /* МУХИ - МИШЕНИ */
    .fly {
      position: absolute;
      width: 80px;
      height: 80px;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      background: url('fly_with_letter.png') no-repeat center center / contain;
      z-index: 800;
      transition: transform 0.2s ease;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.5));
    }
    
    .fly:hover {
      transform: scale(1.2);
      filter: drop-shadow(0 0 20px yellow);
    }
    
    /* БУКВЫ НА МУХАХ - ТЕПЕРЬ БЕЛЫЕ */
    .fly-letter {
      position: relative;
      top: 15px;
      font-weight: bold;
      font-size: 36px;
      color: white;
      text-shadow: 2px 2px 0 #000, 0 0 10px rgba(255,255,255,0.5);
      font-family: Arial, sans-serif;
      pointer-events: none;
      z-index: 801;
    }
    
    .fly.hint {
      animation: hintBlink 0.8s ease-in-out infinite;
      filter: drop-shadow(0 0 20px cyan) brightness(1.3);
    }
    
    @keyframes hintBlink {
      0%, 100% { filter: drop-shadow(0 0 10px cyan); }
      50% { filter: drop-shadow(0 0 30px white) brightness(1.5); }
    }
    
    /* ПОДСВЕЧЕННЫЕ БУКВЫ В СЛОВЕ */
    .highlighted_letter {
      color: #00ffff !important;
      text-shadow: 0 0 15px cyan, 0 0 30px blue;
      transition: transform 0.3s ease;
      transform-origin: center;
    }
    
    .highlight-anim {
      animation: highlightGrow 0.4s ease forwards;
    }
    
    @keyframes highlightGrow {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    
    /* ПРИЦЕЛ */
    #crosshair {
      position: absolute;
      width: 70px;
      height: 70px;
      pointer-events: none;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle fill="none" stroke="%23ff0000" stroke-width="5" cx="50" cy="50" r="35"/><line x1="50" y1="10" x2="50" y2="30" stroke="%23ff0000" stroke-width="5"/><line x1="50" y1="70" x2="50" y2="90" stroke="%23ff0000" stroke-width="5"/><line x1="10" y1="50" x2="30" y2="50" stroke="%23ff0000" stroke-width="5"/><line x1="70" y1="50" x2="90" y2="50" stroke="%23ff0000" stroke-width="5"/><circle fill="%23ff0000" cx="50" cy="50" r="8"/></svg>') no-repeat center center / contain;
      z-index: 1200;
      filter: drop-shadow(0 0 10px red);
    }
    
    /* КНОПКИ УПРАВЛЕНИЯ - В ЛЕВОМ ВЕРХНЕМ УГЛУ */
    #controls {
      position: absolute;
      top: 30px;
      left: 30px;
      display: flex;
      gap: 15px;
      z-index: 1600;
    }
    
    button {
      font-size: 1.5vw;
      padding: 12px 20px;
      cursor: pointer;
      border-radius: 15px;
      border: none;
      background: linear-gradient(135deg, #0066aa, #003366);
      color: white;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s;
      border: 2px solid #00aaff;
      box-shadow: 0 0 15px rgba(0, 170, 255, 0.5);
      font-weight: bold;
    }
    
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 25px cyan;
      background: linear-gradient(135deg, #0077cc, #004488);
    }
    
    .btn-icon {
      width: 24px;
      height: 24px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      filter: brightness(0) invert(1);
    }
    
    #btn-pause .btn-icon {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="25" height="60" fill="white"/><rect x="55" y="20" width="25" height="60" fill="white"/></svg>');
    }
    
    #btn-dict .btn-icon {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="15" y="20" width="70" height="60" fill="white"/><line x1="30" y1="35" x2="70" y2="35" stroke="%230066aa" stroke-width="5"/><line x1="30" y1="50" x2="70" y2="50" stroke="%230066aa" stroke-width="5"/><line x1="30" y1="65" x2="55" y2="65" stroke="%230066aa" stroke-width="5"/></svg>');
    }
    
    /* GAME OVER */
    #game-over-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 20, 40, 0.95);
      backdrop-filter: blur(10px);
      color: white;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      user-select: none;
    }
    
    #game-over-text {
      font-size: 5vw;
      margin-bottom: 30px;
      text-align: center;
      color: #00ffff;
      text-shadow: 3px 3px 0 #000066;
    }
    
    #final-score {
      font-size: 3.5vw;
      margin-bottom: 30px;
      color: white;
    }
    
    #game-over-buttons {
      display: flex;
      gap: 30px;
      margin-top: 30px;
    }
    
    .game-over-button {
      font-size: 2vw;
      padding: 20px 40px;
      cursor: pointer;
      border-radius: 15px;
      border: none;
      color: white;
      font-weight: bold;
      transition: all 0.2s;
      border: 2px solid #00aaff;
    }
    
    .game-over-button:hover {
      transform: scale(1.1);
      box-shadow: 0 0 30px cyan;
    }
    
    #restart-button {
      background: linear-gradient(135deg, #0066aa, #003366);
    }
    
    #dictionary-button {
      background: linear-gradient(135deg, #2E7D32, #1B5E20);
    }
    
    /* АНИМАЦИИ УРОВНЯ */
    @keyframes fireworkParticle {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
      50% { transform: translate(calc(-50% + var(--end-x)), calc(-50% + var(--end-y))) scale(1); opacity: 1; }
      100% { transform: translate(calc(-50% + var(--end-x)), calc(-50% + var(--end-y))) scale(0); opacity: 0; }
    }
    
    @keyframes levelUpEnter {
      0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
      70% { transform: scale(1.1) rotate(5deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    
    @keyframes levelUpExit {
      0% { transform: scale(1) rotate(0deg); opacity: 1; }
      30% { transform: scale(1.1) rotate(5deg); opacity: 1; }
      100% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
    }
    
    @keyframes confettiFall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }
    
    /* МОБИЛЬНАЯ АДАПТАЦИЯ */
    @media (max-width: 768px) {
      #word-display {
        font-size: 8vw;
        letter-spacing: 8px;
        padding: 10px 15px;
        top: 15px;
        white-space: normal;
        word-break: break-word;
      }
      
      .fly {
        width: 70px;
        height: 70px;
      }
      
      .fly-letter {
        font-size: 30px;
        top: 12px;
      }
      
      .life {
        width: 30px;
        height: 30px;
      }
      
      #crosshair {
        width: 60px;
        height: 60px;
      }
      
      #hud {
        top: 15px;
        right: 15px;
        padding: 10px 15px;
        gap: 12px;
        flex-direction: column;
      }
      
      #score, #level {
        font-size: 5vw;
      }
      
      #controls {
        top: 15px;
        left: 15px;
        gap: 10px;
      }
      
      button {
        font-size: 4vw;
        padding: 8px 12px;
      }
      
      #game-over-text {
        font-size: 8vw;
      }
      
      #final-score {
        font-size: 6vw;
      }
      
      .game-over-button {
        font-size: 4vw;
        padding: 15px 25px;
      }
      
      #game-over-buttons {
        flex-direction: column;
        gap: 15px;
        width: 80%;
      }
    }
  </style>
</head>
<body>

<div id="game-area" tabindex="0">
  <!-- Подводные элементы будут добавляться динамически -->
  
  <div id="word-display"></div>
  
  <div id="hud">
    <div id="level">Уровень: 1</div>
    <div id="lives"></div>
    <div id="score">0</div>
  </div>
  
  <div id="encouragement-message"></div>
  <div id="miss-message">ПРОМАХ!</div>
  
  <div id="game-over-overlay">
    <div id="game-over-text">Игра окончена!</div>
    <div id="final-score">Счёт: 0</div>
    <div id="game-over-buttons">
      <button id="restart-button" class="game-over-button">Начать заново</button>
      <button id="dictionary-button" class="game-over-button">Посмотреть словарь</button>
    </div>
  </div>
  
  <div id="controls">
    <button id="btn-pause"><span class="btn-icon"></span>Пауза</button>
    <button id="btn-dict"><span class="btn-icon"></span>Словарь</button>
  </div>
  
  <div id="crosshair"></div>

  <audio id="sound-correct" preload="auto"></audio>
  <audio id="sound-miss" preload="auto"></audio>
  <audio id="sound-complete" preload="auto"></audio>
  <audio id="sound-level-up" preload="auto"></audio>
</div>

<script>
(() => {
  const gameArea = document.getElementById('game-area');
  const wordDisplay = document.getElementById('word-display');
  const livesContainer = document.getElementById('lives');
  const scoreDisplay = document.getElementById('score');
  const levelDisplay = document.getElementById('level');
  const encouragementMessage = document.getElementById('encouragement-message');
  const missMessage = document.getElementById('miss-message');
  const gameOverOverlay = document.getElementById('game-over-overlay');
  const finalScoreDisplay = document.getElementById('final-score');
  const restartButton = document.getElementById('restart-button');
  const dictionaryButton = document.getElementById('dictionary-button');
  const crosshair = document.getElementById('crosshair');
  const btnPause = document.getElementById('btn-pause');
  const btnDict = document.getElementById('btn-dict');
  
  const soundCorrect = document.getElementById('sound-correct');
  const soundMiss = document.getElementById('sound-miss');
  const soundComplete = document.getElementById('sound-complete');
  const soundLevelUp = document.getElementById('sound-level-up');

  // Пары гласных: правильная буква -> ложная буква
  const vowelPairs = {
    'а': 'о', 'о': 'а',
    'е': 'и', 'и': 'е',
    'у': 'ю', 'ю': 'у',
    'я': 'а', 'ё': 'о'
  };

  // Слова поощрения
  const encouragementWords = [
    "Молодец!", "Отлично!", "Круто!", "Супер!", "Великолепно!", 
    "Превосходно!", "Браво!", "Замечательно!", "Потрясающе!", "Гениально!"
  ];

  // Массив слов
  const words = [
    { word: 'р.д.атор', correct: ['а', 'и'] },
    { word: 'р.ци.нальный', correct: ['а', 'и'] },
    { word: 'р.ци.нализировать', correct: ['а', 'и'] },
    { word: 'р.алист', correct: ['е'] },
    { word: 'р.алистичный', correct: ['е'] },
    { word: 'р.ализм', correct: ['е'] },
    { word: 'р.ж.ссёр', correct: ['е', 'и'] },
    { word: 'р.ж.ссёрский', correct: ['е', 'и'] },
    { word: 'р.з.дент', correct: ['е', 'и'] },
    { word: 'р.з.денция', correct: ['е', 'и'] },
    { word: 'р.месло', correct: ['е'] },
    { word: 'р.месленный', correct: ['е'] },
    { word: 'р.ст.врация', correct: ['е', 'а'] },
    { word: 'р.ст.врационный', correct: ['е', 'а'] },
    { word: 'р.ф.рат', correct: ['е', 'е'] },
    { word: 'р.ф.рировать', correct: ['е', 'е'] },
    { word: 'р.форма', correct: ['е'] },
    { word: 'р.форматор', correct: ['е'] },
    { word: 'р.формировать', correct: ['е'] },
    { word: 'р.цензия', correct: ['е'] },
    { word: 'р.цензент', correct: ['е'] },
    { word: 'р.цензировать', correct: ['е'] },
    { word: 'р.торика', correct: ['е'] },
    { word: 'р.торический', correct: ['е'] },
    { word: 'р.весники', correct: ['о'] },
    { word: 'р.мантичный', correct: ['о'] },
    { word: 'р.мантический', correct: ['о'] },
    { word: 'р.мантизм', correct: ['о'] }
  ];

  let currentWordIndex = 0;
  let currentInserts = [];
  let lives = 3;
  let score = 0;
  let level = 1;
  let paused = false;
  let flies = [];
  let lastActionTime = Date.now();
  let hintTimeout = null;
  let completedWords = new Set();
  let failedWords = new Set();
  let currentLevelWords = [];

  const maxFliesMobile = 5;
  const HINT_DELAY = 8000;
  const BASE_FLY_SPEED = 1.5;
  const LEVEL_SPEED_MULTIPLIER = 1.3;
  const CORRECT_FLY_RATIO = 0.6;
  const LETTER_OFFSET = 15; // Смещение буквы на мухе

  // СОЗДАНИЕ ПОДВОДНОЙ АНИМАЦИИ
  function createUnderwaterAnimation() {
    // Пузырьки
    for (let i = 0; i < 20; i++) {
      setTimeout(() => {
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        const size = 5 + Math.random() * 30;
        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;
        bubble.style.left = `${Math.random() * 100}%`;
        bubble.style.animationDuration = `${4 + Math.random() * 8}s`;
        bubble.style.animationDelay = `${Math.random() * 5}s`;
        gameArea.appendChild(bubble);
      }, i * 100);
    }
    
    // Рыбки
    for (let i = 0; i < 6; i++) {
      setTimeout(() => {
        const fish = document.createElement('div');
        fish.className = 'fish';
        if (Math.random() > 0.5) fish.classList.add('reverse');
        fish.style.top = `${10 + Math.random() * 70}%`;
        fish.style.animationDuration = `${25 + Math.random() * 20}s`;
        fish.style.animationDelay = `${Math.random() * -20}s`;
        fish.style.opacity = 0.3 + Math.random() * 0.3;
        gameArea.appendChild(fish);
      }, i * 200);
    }
    
    // Водоросли
    for (let i = 0; i < 10; i++) {
      const seaweed = document.createElement('div');
      seaweed.className = 'seaweed';
      seaweed.style.left = `${2 + i * 9}%`;
      seaweed.style.height = `${100 + Math.random() * 80}px`;
      seaweed.style.animationDelay = `${Math.random() * 3}s`;
      gameArea.appendChild(seaweed);
    }
  }
  
  // ВЗРЫВ
  function createExplosion(x, y) {
    const explosion = document.createElement('div');
    explosion.className = 'explosion';
    explosion.style.left = `${x}px`;
    explosion.style.top = `${y}px`;
    
    for (let i = 0; i < 10; i++) {
      const particle = document.createElement('div');
      particle.className = 'explosion-particle';
      const angle = (i / 10) * Math.PI * 2;
      const distance = 20 + Math.random() * 40;
      particle.style.transform = `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px)`;
      particle.style.background = `radial-gradient(circle, ${['#00ffff', '#0066ff', '#0033aa'][Math.floor(Math.random() * 3)]}, #000066)`;
      explosion.appendChild(particle);
    }
    
    gameArea.appendChild(explosion);
    
    setTimeout(() => {
      if (explosion.parentNode) explosion.parentNode.removeChild(explosion);
    }, 500);
  }

  function isMobile() {
    return /Mobi|Android/i.test(navigator.userAgent);
  }

  function getCurrentFlySpeed() {
    return BASE_FLY_SPEED * Math.pow(LEVEL_SPEED_MULTIPLIER, level - 1);
  }

  function shuffleWords() {
    currentLevelWords = [...words];
    for (let i = currentLevelWords.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [currentLevelWords[i], currentLevelWords[j]] = [currentLevelWords[j], currentLevelWords[i]];
    }
  }

  function getCurrentWord() {
    return currentLevelWords[currentWordIndex];
  }

  function renderLives() {
    livesContainer.innerHTML = '';
    for(let i = 0; i < lives; i++) {
      const life = document.createElement('div');
      life.className = 'life';
      livesContainer.appendChild(life);
    }
  }

  function renderScore() {
    scoreDisplay.textContent = score;
  }

  function renderLevel() {
    levelDisplay.textContent = `Уровень: ${level}`;
  }

  function showLevelUpAnimation() {
    try { 
      soundLevelUp.currentTime = 0; 
      soundLevelUp.play().catch(e => console.log('Audio error:', e));
    } catch(e) {}

    const colors = ['#00ffff', '#0066ff', '#0033aa', '#0099ff', '#33ccff'];
    const letters = 'АБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ';
    
    for (let i = 0; i < 25; i++) {
      setTimeout(() => {
        const particle = document.createElement('div');
        const letter = letters[Math.floor(Math.random() * letters.length)];
        particle.textContent = letter;
        particle.style.cssText = `
          position: absolute;
          top: 50%;
          left: 50%;
          font-size: ${20 + Math.random() * 30}px;
          font-weight: bold;
          color: ${colors[Math.floor(Math.random() * colors.length)]};
          text-shadow: 2px 2px 0 #000066;
          pointer-events: none;
          z-index: 1800;
          transform: translate(-50%, -50%);
          animation: fireworkParticle 1.5s ease-out forwards;
        `;
        
        const angle = Math.random() * Math.PI * 2;
        const distance = 100 + Math.random() * 200;
        particle.style.setProperty('--end-x', `${Math.cos(angle) * distance}px`);
        particle.style.setProperty('--end-y', `${Math.sin(angle) * distance}px`);
        
        gameArea.appendChild(particle);
        
        setTimeout(() => {
          if (particle.parentNode) particle.parentNode.removeChild(particle);
        }, 1500);
      }, i * 60);
    }

    for (let i = 0; i < 50; i++) {
      setTimeout(() => {
        const confetti = document.createElement('div');
        confetti.style.cssText = `
          position: absolute;
          top: -20px;
          left: ${Math.random() * 100}%;
          width: 15px;
          height: 15px;
          background: ${colors[Math.floor(Math.random() * colors.length)]};
          border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
          pointer-events: none;
          z-index: 1700;
          animation: confettiFall ${1 + Math.random() * 2}s linear forwards;
        `;
        gameArea.appendChild(confetti);
        
        setTimeout(() => {
          if (confetti.parentNode) confetti.parentNode.removeChild(confetti);
        }, 3000);
      }, i * 40);
    }

    setTimeout(() => {
      const levelUpDiv = document.createElement('div');
      levelUpDiv.innerHTML = `
        <div style="font-size: 8vw; font-weight: bold; color: #00ffff; text-shadow: 4px 4px 0 #000066, 8px 8px 0 rgba(0,0,102,0.3);">
          УРОВЕНЬ ${level}!
        </div>
        <div style="font-size: 3vw; margin-top: 30px; color: white; text-shadow: 2px 2px 0 #000066;">
          ✨ Мухи стали быстрее! ×${LEVEL_SPEED_MULTIPLIER.toFixed(1)} ✨
        </div>
      `;
      levelUpDiv.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 20, 40, 0.95);
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2500;
        animation: levelUpEnter 0.8s ease-out;
      `;
      
      document.body.appendChild(levelUpDiv);
      
      setTimeout(() => {
        levelUpDiv.style.animation = 'levelUpExit 0.8s ease-in forwards';
        setTimeout(() => {
          if (levelUpDiv.parentNode) levelUpDiv.parentNode.removeChild(levelUpDiv);
        }, 800);
      }, 2500);
    }, 500);
  }

  function insertLetters(word, letters) {
    let result = '';
    let letterIndex = 0;
    for (let i = 0; i < word.length; i++) {
      if(word[i] === '.') {
        if (letters[letterIndex]) {
          result += `<span class="highlighted_letter">${letters[letterIndex]}</span>`;
        } else {
          result += '<span class="highlighted_letter" style="opacity:0.5;">_</span>';
        }
        letterIndex++;
      } else {
        result += word[i];
      }
    }
    return result;
  }

  function getCompletedWord(wordObj, inserts) {
    let result = '';
    let letterIndex = 0;
    for (let i = 0; i < wordObj.word.length; i++) {
      if(wordObj.word[i] === '.') {
        result += `<span class="highlighted_letter">${inserts[letterIndex]}</span>`;
        letterIndex++;
      } else {
        result += wordObj.word[i];
      }
    }
    return result;
  }
  
  function updateWordDisplay() {
    const wordObj = getCurrentWord();
    const displayed = insertLetters(wordObj.word, currentInserts);
    wordDisplay.innerHTML = displayed;
  }

  function clearFlies() {
    for(const f of flies) {
      if(f.element && f.element.parentNode) {
        f.element.parentNode.removeChild(f.element);
      }
    }
    flies = [];
    if (hintTimeout) {
      clearTimeout(hintTimeout);
      hintTimeout = null;
    }
  }

  function spawnFlies() {
    clearFlies();
    const wordObj = getCurrentWord();
    const maxFlies = isMobile() ? maxFliesMobile : Math.max(8, wordObj.correct.length * 4);
    
    const correctLettersNeeded = wordObj.correct.filter((letter, index) => !currentInserts[index]);
    
    // СОЗДАЕМ ПРАВИЛЬНЫЕ МУХИ
    correctLettersNeeded.forEach(letter => {
      const correctFliesCount = Math.max(2, Math.floor(maxFlies * CORRECT_FLY_RATIO / correctLettersNeeded.length));
      
      for(let i = 0; i < correctFliesCount; i++) {
        createFly(letter, true);
      }
    });
    
    // СОЗДАЕМ НЕПРАВИЛЬНЫЕ МУХИ (разные варианты)
    const remainingFlies = maxFlies - document.querySelectorAll('.fly').length;
    for(let i = 0; i < remainingFlies; i++) {
      // Берем случайную правильную букву и делаем её неправильную пару
      const randomCorrect = wordObj.correct[Math.floor(Math.random() * wordObj.correct.length)];
      
      // Иногда используем другую правильную букву как неправильную
      let falseLetter;
      if (Math.random() > 0.3) {
        falseLetter = vowelPairs[randomCorrect] || 'а';
      } else {
        // Иногда используем другую правильную букву (чтобы было больше разнообразия)
        const otherCorrect = wordObj.correct.filter(l => l !== randomCorrect);
        falseLetter = otherCorrect.length > 0 ? otherCorrect[0] : vowelPairs[randomCorrect] || 'о';
      }
      
      createFly(falseLetter, false);
    }
    
    lastActionTime = Date.now();
    startHintTimer();
  }

  function createFly(letter, isCorrect) {
    const fly = document.createElement('div');
    fly.className = 'fly';
    
    // Случайная позиция, но не слишком близко к краям
    const x = 50 + Math.random() * (gameArea.clientWidth - 150);
    const y = 100 + Math.random() * (gameArea.clientHeight - 200);
    
    fly.style.left = `${x}px`;
    fly.style.top = `${y}px`;
    fly.dataset.correct = isCorrect ? '1' : '0';
    fly.dataset.letter = letter;
    
    // Буква на мухе - теперь белая
    const letterElement = document.createElement('div');
    letterElement.className = 'fly-letter';
    letterElement.textContent = letter;
    fly.appendChild(letterElement);
    
    fly.addEventListener('click', (e) => {
      e.stopPropagation();
      if(paused) return;
      
      const rect = fly.getBoundingClientRect();
      const gameRect = gameArea.getBoundingClientRect();
      createExplosion(rect.left + rect.width/2 - gameRect.left, rect.top + rect.height/2 - gameRect.top);
      
      lastActionTime = Date.now();
      resetHint();
      
      if(fly.dataset.correct === '1') {
        onCorrectLetter(letter);
        try { soundCorrect.play(); } catch(e) {}
      } else {
        onMiss();
        try { soundMiss.play(); } catch(e) {}
      }
      
      const index = flies.findIndex(f => f.element === fly);
      if (index !== -1) {
        if (fly.parentNode) fly.parentNode.removeChild(fly);
        flies.splice(index, 1);
      }
    });
    
    gameArea.appendChild(fly);
    
    const speed = getCurrentFlySpeed() + Math.random() * getCurrentFlySpeed();
    const angle = Math.random() * Math.PI * 2;
    flies.push({
      element: fly, 
      x, y, 
      speedX: Math.cos(angle) * speed, 
      speedY: Math.sin(angle) * speed
    });
  }

  function startHintTimer() {
    if (hintTimeout) clearTimeout(hintTimeout);
    hintTimeout = setTimeout(showHint, HINT_DELAY);
  }

  function resetHint() {
    if (hintTimeout) {
      clearTimeout(hintTimeout);
      hintTimeout = null;
    }
    flies.forEach(fly => {
      if (fly.element) fly.element.classList.remove('hint');
    });
  }

  function showHint() {
    const wordObj = getCurrentWord();
    const nextCorrectIndex = currentInserts.length;
    if (nextCorrectIndex >= wordObj.correct.length) return;
    
    const neededLetter = wordObj.correct[nextCorrectIndex];
    
    flies.forEach(fly => {
      if (fly.element && fly.element.dataset.letter === neededLetter && fly.element.dataset.correct === '1') {
        fly.element.classList.add('hint');
      }
    });
    
    hintTimeout = setTimeout(() => {
      resetHint();
      startHintTimer();
    }, 3000);
  }

  function showEncouragement() {
    const randomWord = encouragementWords[Math.floor(Math.random() * encouragementWords.length)];
    encouragementMessage.textContent = randomWord;
    encouragementMessage.style.opacity = '1';
    encouragementMessage.style.animation = 'encouragementPulse 1.5s ease-in-out';
    
    setTimeout(() => {
      encouragementMessage.style.opacity = '0';
    }, 2000);
  }

  function onCorrectLetter(letter) {
    const wordObj = getCurrentWord();
    if(currentInserts.length < wordObj.correct.length) {
      currentInserts.push(letter);
      score += 10;
      renderScore();
      updateWordDisplay();
      
      // Анимация для вставленной буквы
      const spans = wordDisplay.querySelectorAll('.highlighted_letter');
      if (spans.length > 0) {
        spans[spans.length - 1].classList.add('highlight-anim');
        setTimeout(() => {
          spans[spans.length - 1].classList.remove('highlight-anim');
        }, 400);
      }
    }
    
    if(currentInserts.length === wordObj.correct.length) {
      const originalIndex = words.findIndex(w => w.word === wordObj.word);
      completedWords.add(originalIndex);
      try { soundComplete.play(); } catch(e) {}
      
      showEncouragement();
      
      wordDisplay.style.transform = 'translateX(-50%) scale(1.1)';
      
      setTimeout(() => {
        wordDisplay.style.transform = 'translateX(-50%) scale(1)';
        
        setTimeout(() => {
          nextWord();
        }, 1000);
      }, 500);
    } else {
      spawnFlies();
    }
  }

  function onMiss() {
    lives--;
    renderLives();
    
    missMessage.style.opacity = '1';
    missMessage.style.animation = 'missPulse 1.5s ease-in-out';
    setTimeout(() => {
      missMessage.style.opacity = '0';
    }, 1500);
    
    const wordObj = getCurrentWord();
    const originalIndex = words.findIndex(w => w.word === wordObj.word);
    failedWords.add(originalIndex);
    
    if(lives <= 0) {
      showGameOver();
    } else {
      spawnFlies();
    }
  }

  function showGameOver() {
    finalScoreDisplay.textContent = `Счёт: ${score}`;
    gameOverOverlay.style.display = 'flex';
  }

  function resetGame() {
    currentWordIndex = 0;
    currentInserts = [];
    lives = 3;
    score = 0;
    level = 1;
    completedWords.clear();
    failedWords.clear();
    shuffleWords();
    renderLives();
    renderScore();
    renderLevel();
    updateWordDisplay();
    spawnFlies();
    gameOverOverlay.style.display = 'none';
  }

  function nextWord() {
    currentWordIndex++;
    if(currentWordIndex >= currentLevelWords.length) {
      const wordsForNextLevel = [...words];
      if (failedWords.size > 0) {
        const failedWordsArray = Array.from(failedWords);
        failedWordsArray.forEach(index => {
          if (!wordsForNextLevel.includes(words[index])) {
            wordsForNextLevel.push(words[index]);
          }
        });
        failedWords.clear();
      }
      
      level++;
      currentWordIndex = 0;
      currentLevelWords = [...wordsForNextLevel];
      
      for (let i = currentLevelWords.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [currentLevelWords[i], currentLevelWords[j]] = [currentLevelWords[j], currentLevelWords[i]];
      }
      
      renderLevel();
      
      showLevelUpAnimation();
      
      setTimeout(() => {
        currentInserts = [];
        updateWordDisplay();
        spawnFlies();
      }, 3500);
      
    } else {
      currentInserts = [];
      updateWordDisplay();
      spawnFlies();
    }
  }

  function showDictionary() {
    let dictText = "<div style='text-align: center; font-size: 20px; margin-bottom: 20px; font-weight: bold; color: #0066aa;'>Словарь изученных слов</div>";
    let hasWords = false;
    
    const allLearnedWords = Array.from(completedWords).map(index => ({
      wordObj: words[index],
      isCompleted: true
    }));
    
    if (failedWords.size > 0) {
      Array.from(failedWords).forEach(index => {
        if (!completedWords.has(index)) {
          allLearnedWords.push({
            wordObj: words[index],
            isCompleted: false
          });
        }
      });
    }
    
    if (allLearnedWords.length > 0) {
      hasWords = true;
      
      const completedWordsList = allLearnedWords.filter(item => item.isCompleted);
      const failedWordsList = allLearnedWords.filter(item => !item.isCompleted);
      
      if (completedWordsList.length > 0) {
        dictText += "<div style='margin-bottom: 15px;'><div style='color: #2E7D32; font-weight: bold; margin-bottom: 10px;'>✓ Успешно изученные слова:</div>";
        completedWordsList.forEach(item => {
          const completedWordHTML = getCompletedWord(item.wordObj, item.wordObj.correct);
          dictText += `<div style='margin: 5px 0; font-size: 16px; padding: 5px; background: #E8F5E8; border-radius: 5px;'>${completedWordHTML}</div>`;
        });
        dictText += "</div>";
      }
      
      if (failedWordsList.length > 0) {
        dictText += "<div style='margin-bottom: 15px;'><div style='color: #D2691E; font-weight: bold; margin-bottom: 10px;'>⚠ Слова для повторения (были промахи):</div>";
        failedWordsList.forEach(item => {
          const wordWithDots = item.wordObj.word;
          dictText += `<div style='margin: 5px 0; font-size: 16px; padding: 5px; background: #FFF3E0; border-radius: 5px;'>${wordWithDots}</div>`;
        });
        dictText += "</div>";
      }
    }
    
    if (!hasWords) {
      dictText += "<div style='color: #666; font-style: italic; text-align: center;'>Пока нет изученных слов</div>";
    }
    
    const dictModal = document.createElement('div');
    dictModal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0, 20, 40, 0.95); backdrop-filter: blur(10px); display: flex; justify-content: center;
      align-items: center; z-index: 3000; font-family: Arial, sans-serif;
    `;
    
    const dictContent = document.createElement('div');
    dictContent.style.cssText = `
      background: white; padding: 30px; border-radius: 15px; max-width: 600px;
      max-height: 80vh; overflow-y: auto; text-align: left; box-shadow: 0 0 30px rgba(0, 170, 255, 0.5);
      border: 3px solid #00aaff;
    `;
    
    dictContent.innerHTML = dictText;
    
    const closeButton = document.createElement('button');
    closeButton.textContent = 'Закрыть';
    closeButton.style.cssText = `
      margin-top: 20px; padding: 10px 20px; background: linear-gradient(135deg, #0066aa, #003366);
      color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;
      display: block; margin-left: auto; margin-right: auto; border: 2px solid #00aaff;
      font-weight: bold;
    `;
    closeButton.onclick = () => document.body.removeChild(dictModal);
    
    dictContent.appendChild(closeButton);
    dictModal.appendChild(dictContent);
    dictModal.onclick = (e) => {
      if (e.target === dictModal) document.body.removeChild(dictModal);
    };
    
    document.body.appendChild(dictModal);
  }

  function updateCrosshair(x, y) {
    const rect = gameArea.getBoundingClientRect();
    let cx = x - rect.left - 35;
    let cy = y - rect.top - 35;
    
    cx = Math.max(0, Math.min(cx, rect.width - 70));
    cy = Math.max(0, Math.min(cy, rect.height - 70));
    
    crosshair.style.left = `${cx}px`;
    crosshair.style.top = `${cy}px`;
  }

  function moveFlies() {
    const rect = gameArea.getBoundingClientRect();
    
    for(let fly of flies) {
      if (!fly.element || !fly.element.parentNode) continue;
      
      fly.x += fly.speedX;
      fly.y += fly.speedY;
      
      if(fly.x <= 0 || fly.x >= rect.width - 80) {
        fly.speedX *= -1;
        fly.x = Math.max(0, Math.min(fly.x, rect.width - 80));
      }
      if(fly.y <= 80 || fly.y >= rect.height - 130) { // Не залетают на слово и кнопки
        fly.speedY *= -1;
        fly.y = Math.max(80, Math.min(fly.y, rect.height - 130));
      }
      
      fly.element.style.left = `${fly.x}px`;
      fly.element.style.top = `${fly.y}px`;
    }
  }

  function gameLoop() {
    if(!paused) {
      moveFlies();
      
      if (Date.now() - lastActionTime > HINT_DELAY - 1000 && !hintTimeout) {
        startHintTimer();
      }
    }
    requestAnimationFrame(gameLoop);
  }

  function togglePause() {
    paused = !paused;
    btnPause.innerHTML = paused ? '<span class="btn-icon"></span>Продолжить' : '<span class="btn-icon"></span>Пауза';
    if (!paused) {
      lastActionTime = Date.now();
    }
  }

  // Event listeners
  gameArea.addEventListener('mousemove', (e) => {
    if(!paused) updateCrosshair(e.clientX, e.clientY);
  });
  
  gameArea.addEventListener('touchmove', (e) => {
    if(!paused && e.touches.length) {
      updateCrosshair(e.touches[0].clientX, e.touches[0].clientY);
      e.preventDefault();
    }
  }, {passive: false});

  btnPause.addEventListener('click', togglePause);
  btnDict.addEventListener('click', showDictionary);
  restartButton.addEventListener('click', resetGame);
  dictionaryButton.addEventListener('click', showDictionary);

  // Инициализация
  createUnderwaterAnimation();
  gameArea.focus();
  shuffleWords();
  renderLives();
  renderScore();
  renderLevel();
  updateWordDisplay();
  spawnFlies();
  gameLoop();

  window.addEventListener('blur', () => {
    if (!paused) togglePause();
  });

  // Обработка изменения размера окна
  window.addEventListener('resize', () => {
    clearFlies();
    spawnFlies();
  });

})();
</script>

</body>
</html>